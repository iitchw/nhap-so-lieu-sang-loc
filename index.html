<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PH·∫¶N M·ªÄM NH·∫¨P D·ªÆ LI·ªÜU KH√ÅM S√ÄNG L·ªåC</title>
    <!-- Dexie.js - Th∆∞ vi·ªán cho IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <!-- SheetJS - Th∆∞ vi·ªán ƒë·ªÉ t·∫°o file XLSX -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --card-bg: #ffffff; --body-bg: #f0f2f5; --border-color: #dee2e6; --text-color: #212529;
            --muted-text-color: #6c757d; --primary-color: #0d6efd; --secondary-color: #6c757d;
            --success-color: #198754; --danger-color: #dc3545; --warning-color: #ffc107;
            --primary-text-color: #ffffff; --input-bg: #ffffff; --input-border: #ced4da; --header-bg: #f8f9fa;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: var(--body-bg); color: var(--text-color); margin: 0; font-size: 16px; }
        .app-layout { display: flex; min-height: 100vh; }
        .sidebar { width: 280px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { font-size: 1.2rem; margin: 0 0 20px 0; text-align: center; }
        .control-button { display: block; width: 100%; background-color: var(--header-bg); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px; padding: 15px; text-align: left; cursor: pointer; font-size: 1rem; font-weight: 500; }
        .control-button:hover { background-color: #e9ecef; }
        .control-button .tooltip { font-size: 0.85rem; color: var(--muted-text-color); margin: 5px 0 0 0; font-weight: normal; }
        .main-content { flex-grow: 1; padding: 20px; }
        .main-header h1 { font-size: 1.8rem; margin: 0; text-align: center; }
        .card { border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 24px; background-color: var(--card-bg); }
        .card-header { background-color: var(--header-bg); padding: 12px 16px; font-weight: bold; border-bottom: 1px solid var(--border-color); }
        .card-content { padding: 20px; }
        .grid-2-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;}
        .form-group:last-child { margin-bottom: 0; }
        input[type="text"], input[type="number"], input[type="tel"], input[type="date"], select { width: 100%; padding: 10px; border: 1px solid var(--input-border); border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .button { padding: 10px 16px; font-size: 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; text-align: center; }
        .button-primary { background-color: var(--primary-color); color: var(--primary-text-color); }
        .button-secondary { background-color: var(--secondary-color); color: var(--primary-text-color); }
        .submit-button { width: 100%; padding: 16px; font-size: 1.2rem; }
        .tab-nav { border-bottom: 2px solid var(--border-color); margin-bottom: 20px; display: flex; }
        .tab-link { background-color: transparent; border: none; padding: 14px 20px; cursor: pointer; font-size: 1.1rem; font-weight: 500; color: var(--muted-text-color); border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-link.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid var(--border-color); padding: 12px; text-align: left; }
        th { background-color: var(--header-bg); }
        .filter-row input { width: 95%; padding: 8px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .report-item { background: #fff; border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; }
        .report-item .value { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        .report-item .label { font-size: 1rem; color: var(--muted-text-color); margin-top: 5px; }
        .hidden { display: none; }
        @media (max-width: 992px) { .app-layout { flex-direction: column; } .sidebar { width: 100%; border-right: none; border-bottom: 1px solid var(--border-color); } }
        .pl-6 { padding-left: 24px; margin-top: -10px; }
        .border-l { border-left: 2px solid var(--border-color); padding-left: 24px; }
        .radio-group, .checkbox-group { display: flex; gap: 20px; padding-top: 8px; }
        .checkbox-group-vertical { display: flex; flex-direction: column; gap: 12px; padding-top: 8px; }
        label, .form-label { font-weight: 500; }
        .radio-group label, .checkbox-group label, .checkbox-group-vertical label { font-weight: normal; display: flex; align-items: center; gap: 8px; }
        .spirometry-table { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; align-items: center; margin-top: 10px; }
        .spirometry-table .header { font-weight: bold; text-align: center; }
        .spirometry-table .label { font-weight: 500; }
        .spirometry-table input { text-align: center; }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <h2>B·∫£ng ƒëi·ªÅu khi·ªÉn</h2>
            <button class="control-button" id="importDbBtn">
                Nh·∫≠p d·ªØ li·ªáu (json)
                <p class="tooltip">X√≥a d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file backup.</p>
            </button>
            <input type="file" id="fileLoader" class="hidden" accept=".json">
            <button class="control-button" id="exportDbBtn">
                Sao l∆∞u d·ªØ li·ªáu (json)
                <p class="tooltip">T·∫°o m·ªôt file backup ch·ª©a to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i.</p>
            </button>
            <button class="control-button" id="exportXlsxBtn">
                Xu·∫•t danh s√°ch (xlsx)
                <p class="tooltip">T·∫°o m·ªôt file Excel ch·ª©a danh s√°ch b·ªánh nh√¢n ƒë·ªÉ b√°o c√°o.</p>
            </button>
            <button class="control-button" id="clearDbBtn">
                X√≥a to√†n b·ªô d·ªØ li·ªáu
                <p class="tooltip">X√≥a s·∫°ch CSDL tr√™n tr√¨nh duy·ªát n√†y ƒë·ªÉ b·∫Øt ƒë·∫ßu l·∫°i t·ª´ ƒë·∫ßu.</p>
            </button>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="main-header">
                <h1>PH·∫¶N M·ªÄM NH·∫¨P D·ªÆ LI·ªÜU KH√ÅM S√ÄNG L·ªåC B·ªÜNH H√î H·∫§P<br>B·ªánh vi·ªán Ph·ªïi th√†nh ph·ªë Hu·∫ø</h1>
            </div>

            <div id="appContainer">
                <div class="tab-nav">
                    <button class="tab-link active" data-tab="nhaplieu">üìù Nh·∫≠p Li·ªáu</button>
                    <button class="tab-link" data-tab="danhsach">üìã Danh S√°ch</button>
                    <button class="tab-link" data-tab="baocao">üìä B√°o C√°o</button>
                </div>

                <div id="nhaplieu" class="tab-content active">
                    <div id="formContainer">
                        <div style="text-align: center; padding: 10px; background-color: #f1f3f5; border-radius: 8px 8px 0 0; border: 1px solid var(--border-color); border-bottom: none;">
                            <h2 id="formTitle" style="margin:0;">PHI·∫æU KH√ÅM S√ÄNG L·ªåC C·ªòNG ƒê·ªíNG</h2>
                        </div>
                        <form id="surveyForm">
                            <!-- I. Th√¥ng tin chung -->
                            <div class="card" style="border-radius: 0; border-top:none; margin-bottom: 24px;">
                                <div class="card-header">I. TH√îNG TIN CHUNG</div>
                                <div class="card-content grid-2-cols">
                                    <div class="form-group"><label for="patientId">1. M√É S·ªê PHI·∫æU</label><input type="text" id="patientId" name="patientId" readonly></div>
                                    <div class="form-group"><label for="examDate">2.1 NG√ÄY KH√ÅM</label><input type="date" id="examDate" name="examDate" required></div>
                                    <div class="form-group"><label for="location">2.2. N∆†I KH√ÅM</label><select id="location" name="location" required><option value="" disabled selected>Ch·ªçn n∆°i kh√°m</option><option value="C∆° s·ªü 1">TYT Ch√¢n M√¢y c∆° s·ªü 1 - L·ªôc Vƒ©nh</option><option value="C∆° s·ªü 2">TYT Ch√¢n M√¢y c∆° s·ªü 2 - LƒÉng C√¥</option><option value="C∆° s·ªü 3">TYT Ch√¢n M√¢y c∆° s·ªü 3 - L·ªôc Ti·∫øn</option><option value="C∆° s·ªü 4">TYT Ch√¢n M√¢y c∆° s·ªü 4 - L·ªôc Thu·ª∑</option></select></div>
                                    <div class="form-group"><label for="fullName">3. H·ªå V√Ä T√äN</label><input type="text" id="fullName" name="fullName" required></div>
                                    <div class="form-group"><label for="phone">4. S·ªê ƒêI·ªÜN THO·∫†I</label><input type="tel" id="phone" name="phone" pattern="[0-9]{10}"></div>
                                    <div class="form-group"><label for="birthYear">5. NƒÇM SINH</label><input type="number" id="birthYear" name="birthYear" required min="1900" max="2025"></div>
                                    <div class="form-group"><label for="address">6. TH√îN/T·ªî D√ÇN PH·ªê</label><input type="text" id="address" name="address" required></div>
                                    <div class="form-group"><label class="form-label">7. GI·ªöI T√çNH</label><div class="radio-group"><label><input type="radio" name="gender" value="Nam" required> Nam</label><label><input type="radio" name="gender" value="N·ªØ"> N·ªØ</label></div></div>
                                    <div class="form-group hidden" id="isPregnantSection"><label class="form-label">7.1. B·∫°n c√≥ ƒëang mang thai kh√¥ng?</label><div class="radio-group"><label><input type="radio" name="isPregnant" value="C√≥"> C√≥</label><label><input type="radio" name="isPregnant" value="Kh√¥ng"> Kh√¥ng</label></div></div>
                                </div>
                            </div>
                            <!-- II. Ti·ªÅn s·ª≠ -->
                            <div class="card"><div class="card-header">II. TI·ªÄN S·ª¨</div><div class="card-content"><div class="form-group"><label class="form-label">8. TI·ªÄN S·ª¨ B·∫¢N TH√ÇN</label><div class="checkbox-group-vertical"><label><input type="checkbox" name="personalHistory" value="Lao" id="historyTb"> Lao</label><label><input type="checkbox" name="personalHistory" value="BPTNMT"> BPTNMT</label><label><input type="checkbox" name="personalHistory" value="HPQ"> HPQ</label></div></div><div class="form-group hidden pl-6" id="tuberculosisTreatmentsSection"><label for="tuberculosisTreatments">8.1. S·ªë l·∫ßn ƒëi·ªÅu tr·ªã Lao</label><input type="number" id="tuberculosisTreatments" name="tuberculosisTreatments" min="0"></div><div class="form-group"><label class="form-label">9. TI·ªÄN S·ª¨ TI·∫æP X√öC NG∆Ø·ªúI M·∫ÆC LAO</label><div class="radio-group"><label><input type="radio" name="contactWithTuberculosis" value="C√≥" required> C√≥</label><label><input type="radio" name="contactWithTuberculosis" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="hidden pl-6" id="contactSourceSection"><div class="form-group"><label for="contactSourceName">9.1. H·ªç v√† t√™n ng∆∞·ªùi ng∆∞·ªùi m·∫Øc lao ƒë√£ ti·∫øp x√∫c</label><input type="text" id="contactSourceName" name="contactSourceName"></div><div class="form-group"><label class="form-label">9.2. Lo·∫°i lao c·ªßa ngu·ªìn ti·∫øp x√∫c</label><div class="radio-group"><label><input type="radio" name="contactSourceTbType" value="Lao nh·∫°y c·∫£m"> Lao nh·∫°y c·∫£m</label><label><input type="radio" name="contactSourceTbType" value="Lao kh√°ng thu·ªëc"> Lao kh√°ng thu·ªëc</label></div></div></div></div></div>
                            <!-- III. Kh√°m s√†ng l·ªçc -->
                            <div class="card"><div class="card-header">III. KH√ÅM S√ÄNG L·ªåC</div><div class="card-content"><div class="form-group"><label for="xrayResult">10. K·∫æT QU·∫¢ X-QUANG</label><select id="xrayResult" name="xrayResult" required><option value="" disabled selected>Ch·ªçn k·∫øt qu·∫£</option><option value="B√¨nh th∆∞·ªùng">B√¨nh th∆∞·ªùng</option><option value="B·∫•t th∆∞·ªùng nghi lao">B·∫•t th∆∞·ªùng nghi lao</option><option value="B·∫•t th∆∞·ªùng nghi BPTNMT&HPQ">B·∫•t th∆∞·ªùng nghi BPTNMT&HPQ</option><option value="B·∫•t th∆∞·ªùng kh√°c">B·∫•t th∆∞·ªùng kh√°c</option><option value="KH√îNG CH·ª§P">KH√îNG CH·ª§P</option></select></div><div class="form-group"><label class="form-label">11. D·∫§U HI·ªÜU NGHI LAO - nhi·ªÅu l·ª±a ch·ªçn</label><div class="checkbox-group-vertical"><label><input type="checkbox" name="suspectedTbSigns" value="Ho k√©o d√†i"> Ho k√©o d√†i</label><label><input type="checkbox" name="suspectedTbSigns" value="S·ª•t c√¢n"> S·ª•t c√¢n</label><label><input type="checkbox" name="suspectedTbSigns" value="S·ªët"> S·ªët</label><label><input type="checkbox" name="suspectedTbSigns" value="Ra m·ªì h√¥i tr·ªôm v·ªÅ ƒë√™m"> Ra m·ªì h√¥i tr·ªôm v·ªÅ ƒë√™m</label></div></div><div class="form-group"><label class="form-label">12. D·∫§U HI·ªÜN G·ª¢I √ù HEN PH·∫æ QU·∫¢N - nhi·ªÅu l·ª±a ch·ªçn</label><div class="checkbox-group-vertical"><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Kh√≥ th·ªü kh√≤ kh√®"> Kh√≥ th·ªü, kh√≤ kh√®, th·ªü r√≠t, ƒë·∫∑c bi·ªát th√¨ th·ªü ra</label><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Ti·ªÅn s·ª≠ c∆°n hen"> Ti·ªÅn s·ª≠ c√≥ c∆°n kh√≥ th·ªü ki·ªÉu hen</label><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Ti·ªÅn s·ª≠ d·ªã ·ª©ng b·∫£n th√¢n"> Ti·ªÅn s·ª≠ b·∫£n th√¢n d·ªã ·ª©ng</label><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Ti·ªÅn s·ª≠ d·ªã ·ª©ng gia ƒë√¨nh"> Ti·ªÅn s·ª≠ gia ƒë√¨nh d·ªã ·ª©ng/hen</label><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Th·ªùi ƒëi·ªÉm xu·∫•t hi·ªán c∆°n"> C∆°n kh√≥ th·ªü xu·∫•t hi·ªán v·ªÅ ƒë√™m/theo m√πa/sau k√≠ch th√≠ch</label><label><input type="checkbox" name="suggestiveAsthmaSigns" value="Gi·∫£m tri·ªáu ch·ª©ng khi ƒëi·ªÅu tr·ªã"> C√≥ gi·∫£m tri·ªáu ch·ª©ng khi d√πng thu·ªëc gi√£n ph·∫ø qu·∫£n/corticoid</label></div></div><div class="form-group"><label class="form-label">13. D·∫§U HI·ªÜU G·ª¢I √ù BPTNMT - nhi·ªÅu l·ª±a ch·ªçn</label><div class="checkbox-group-vertical"><label><input type="checkbox" name="suggestiveCopdSigns" value="Tu·ªïi ‚â• 40"> Tu·ªïi ‚â• 40</label><label><input type="checkbox" name="suggestiveCopdSigns" value="H√∫t thu·ªëc"> H√∫t thu·ªëc l√°, thu·ªëc l√†o</label><label><input type="checkbox" name="suggestiveCopdSigns" value="Ti·∫øp x√∫c kh√≥i b·∫øp"> Ti·∫øp x√∫c kh√≥i b·∫øp, kh√≥i r∆°m r·∫° th∆∞·ªùng xuy√™n</label><label><input type="checkbox" name="suggestiveCopdSigns" value="Ti·∫øp x√∫c b·ª•i h√≥a ch·∫•t"> Ti·∫øp x√∫c v·ªõi b·ª•i v√† h√≥a ch·∫•t ngh·ªÅ nghi·ªáp</label><label><input type="checkbox" name="suggestiveCopdSigns" value="Kh√≥ th·ªü n·∫∑ng d·∫ßn"> KH√ì TH·ªû n·∫∑ng d·∫ßn, tƒÉng khi g·∫Øng s·ª©c, dai d·∫≥ng</label><label><input type="checkbox" name="suggestiveCopdSigns" value="Ho k√©o d√†i"> HO K√âO D√ÄI li√™n t·ª•c</label><label><input type="checkbox" name="suggestiveCopdSigns" value="Kh·∫°c ƒë·ªùm m·∫°n t√≠nh"> KH·∫†C ƒê·ªúM m·∫°n t√≠nh</label></div></div></div></div>
                            <!-- IV. X√©t nghi·ªám -->
                            <div class="card"><div class="card-header">IV. X√âT NGHI·ªÜM</div><div class="card-content"><div class="grid-2-cols"><div class="form-group"><label class="form-label">14. X√âT NGHI·ªÜM XPERT</label><div class="radio-group"><label><input type="radio" name="xpertTest" value="C√≥" required> C√≥</label><label><input type="radio" name="xpertTest" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="form-group hidden" id="xpertResultSection"><label for="xpertResult">14.1. K·∫øt qu·∫£ Xpert</label><select id="xpertResult" name="xpertResult"><option value="" disabled selected>Ch·ªçn k·∫øt qu·∫£</option><option value="CH·ªú NH·∫¨P SAU">CH·ªú NH·∫¨P SAU</option><option value="MTB √¢m">MTB √¢m</option><option value="MTB d∆∞∆°ng kh√¥ng kh√°ng Rifampicin">MTB d∆∞∆°ng kh√¥ng kh√°ng Rifampicin</option><option value="MTB d∆∞∆°ng KH√ÅNG Rifampicin">MTB d∆∞∆°ng KH√ÅNG Rifampicin</option><option value="MTB d∆∞∆°ng v·∫øt">MTB d∆∞∆°ng v·∫øt</option><option value="L·ªói">L·ªói</option><option value="Kh√°c">Kh√°c</option></select></div><div class="form-group"><label class="form-label">15. ƒêO CH·ª®C NƒÇNG H√î H·∫§P</label><div class="radio-group"><label><input type="radio" name="spirometryTest" value="C√≥" required> C√≥</label><label><input type="radio" name="spirometryTest" value="Kh√¥ng"> Kh√¥ng</label></div></div></div><div class="hidden" id="spirometryResultsSection" style="margin-top:20px;"><label class="form-label">15.1. K·∫øt qu·∫£ ƒëo ch·ª©c nƒÉng h√¥ h·∫•p</label><div class="spirometry-table"><div class="header">Ch·ªâ s·ªë</div><div class="header">D·ª± ƒëo√°n</div><div class="header">Tr∆∞·ªõc test</div><div class="header">Sau test</div><div class="label">FEV1</div><input type="number" step="0.01" name="fev1_predicted" required><input type="number" step="0.01" name="fev1_pre" required><input type="number" step="0.01" name="fev1_post"><div class="label">FVC</div><input type="number" step="0.01" name="fvc_predicted" required><input type="number" step="0.01" name="fvc_pre" required><input type="number" step="0.01" name="fvc_post"><div class="label">T·ª∑ l·ªá FEV1/FVC (%)</div><input type="number" step="0.1" name="fev1_fvc_ratio_predicted" required><input type="number" step="0.1" name="fev1_fvc_ratio_pre" required><input type="number" step="0.1" name="fev1_fvc_ratio_post"></div></div></div></div>
                            <!-- V. Ch·∫©n ƒëo√°n -->
                            <div class="card"><div class="card-header">V. CH·∫®N ƒêO√ÅN</div><div class="card-content"><div class="form-group"><label class="form-label">16. K·∫æT LU·∫¨N</label><div class="radio-group"><label><input type="radio" name="conclusion" value="B√¨nh th∆∞·ªùng" required> B√åNH TH∆Ø·ªúNG</label><label><input type="radio" name="conclusion" value="B·∫•t th∆∞·ªùng"> B·∫§T TH∆Ø·ªúNG</label></div></div><div class="hidden border-l" id="diagnosisDetailsSection" style="margin-top:20px;"><h4 style="margin-top:0;">Chi ti·∫øt ch·∫©n ƒëo√°n b·∫•t th∆∞·ªùng:</h4><div class="grid-2-cols"><div class="form-group"><label class="form-label">17. Ch·∫©n ƒëo√°n BPTNMT</label><div class="radio-group"><label><input type="radio" name="diagnosisCopd" value="C√≥"> C√≥</label><label><input type="radio" name="diagnosisCopd" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="form-group"><label class="form-label">18. Ch·∫©n ƒëo√°n Hen ph·∫ø qu·∫£n</label><div class="radio-group"><label><input type="radio" name="diagnosisAsthma" value="C√≥"> C√≥</label><label><input type="radio" name="diagnosisAsthma" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="form-group"><label class="form-label">19. Ch·∫©n ƒëo√°n Lao</label><div class="radio-group"><label><input type="radio" name="diagnosisTb" value="C√≥"> C√≥</label><label><input type="radio" name="diagnosisTb" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="form-group hidden" id="diagnosisTbTypeSection"><label for="diagnosisTbType">19.1. Lo·∫°i ch·∫©n ƒëo√°n Lao</label><select id="diagnosisTbType" name="diagnosisTbType"><option value="" disabled selected>Ch·ªçn lo·∫°i ch·∫©n ƒëo√°n</option><option value="CH·ªú NH·∫¨P SAU">CH·ªú NH·∫¨P SAU</option><option value="Lao ph·ªïi c√≥ b·∫±ng ch·ª©ng VK">Lao ph·ªïi c√≥ b·∫±ng ch·ª©ng VK</option><option value="Lao ph·ªïi kh√¥ng c√≥ b·∫±ng ch·ª©ng VK">Lao ph·ªïi kh√¥ng c√≥ b·∫±ng ch·ª©ng VK</option><option value="Lao kh√°ng thu·ªëc">Lao kh√°ng thu·ªëc</option><option value="Lao ngo√†i ph·ªïi">Lao ngo√†i ph·ªïi</option></select></div><div class="form-group"><label class="form-label">20. Ch·∫©n ƒëo√°n b·ªánh kh√°c</label><div class="radio-group"><label><input type="radio" name="diagnosisOther" value="C√≥"> C√≥</label><label><input type="radio" name="diagnosisOther" value="Kh√¥ng"> Kh√¥ng</label></div></div><div class="form-group hidden" id="diagnosisOtherDetailSection"><label for="diagnosisOtherDetail">20.1. Vui l√≤ng ghi r√µ b·ªánh kh√°c</label><input type="text" id="diagnosisOtherDetail" name="diagnosisOtherDetail"></div></div></div></div></div>

                            <button type="submit" class="button button-primary submit-button" id="submitBtn">L∆∞u D·ªØ Li·ªáu</button>
                            <button type="button" class="button button-secondary submit-button hidden" id="cancelEditBtn" style="margin-top:10px;">H·ªßy Ch·ªânh S·ª≠a</button>
                        </form>
                    </div>
                </div>

                <div id="danhsach" class="tab-content">
                    <div class="card">
                        <div class="card-header">Danh s√°ch B·ªánh nh√¢n (hi·ªÉn th·ªã 10 phi·∫øu g·∫ßn nh·∫•t)</div>
                        <div style="overflow-x:auto;">
                            <table>
                                <thead>
                                    <tr><th>M√£ BN</th><th>H·ªç t√™n</th><th>K·∫øt qu·∫£ Xquang</th><th>XN Xpert</th><th>Ch·∫©n ƒëo√°n</th><th>Thao t√°c</th></tr>
                                    <tr class="filter-row">
                                        <td><input type="text" data-filter="patientId" placeholder="L·ªçc..."></td>
                                        <td><input type="text" data-filter="fullName" placeholder="L·ªçc..."></td>
                                        <td><input type="text" data-filter="xrayResult" placeholder="L·ªçc..."></td>
                                        <td><input type="text" data-filter="xpertTest" placeholder="L·ªçc..."></td>
                                        <td><input type="text" data-filter="diagnosis" placeholder="L·ªçc..."></td>
                                        <td></td>
                                    </tr>
                                </thead>
                                <tbody id="surveyListBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="baocao" class="tab-content">
                     <div id="reportContainer"></div>
                </div>
            </div>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- DATABASE SETUP (INDEXEDDB WITH DEXIE.JS) ---
    const db = new Dexie('PhanMemKhamSangLocDB');
    db.version(1).stores({
        surveys: '&patientId, fullName, xrayResult, xpertTest'
    });

    // --- STATE & GLOBAL VARIABLES ---
    let editingPatientId = null;

    // --- UI ELEMENT REFERENCES ---
    const form = document.getElementById('surveyForm');
    const fileLoader = document.getElementById('fileLoader');
    const surveyListBody = document.getElementById('surveyListBody');
    const submitBtn = document.getElementById('submitBtn');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const formTitle = document.getElementById('formTitle');
    const tabLinks = document.querySelectorAll('.tab-link');
    const tabContents = document.querySelectorAll('.tab-content');
    const reportContainer = document.getElementById('reportContainer');

    // --- FORM LOGIC (Conditional Fields with Cleanup) ---
    const genderRadios = document.querySelectorAll('input[name="gender"]');
    const historyTbCheckbox = document.getElementById('historyTb');
    const contactRadios = document.querySelectorAll('input[name="contactWithTuberculosis"]');
    const xpertTestRadios = document.querySelectorAll('input[name="xpertTest"]');
    const spirometryTestRadios = document.querySelectorAll('input[name="spirometryTest"]');
    const conclusionRadios = document.querySelectorAll('input[name="conclusion"]');
    const diagnosisTbRadios = document.querySelectorAll('input[name="diagnosisTb"]');
    const diagnosisOtherRadios = document.querySelectorAll('input[name="diagnosisOther"]');
    
    const isPregnantSection = document.getElementById('isPregnantSection');
    const tuberculosisTreatmentsSection = document.getElementById('tuberculosisTreatmentsSection');
    const contactSourceSection = document.getElementById('contactSourceSection');
    const xpertResultSection = document.getElementById('xpertResultSection');
    const spirometryResultsSection = document.getElementById('spirometryResultsSection');
    const diagnosisDetailsSection = document.getElementById('diagnosisDetailsSection');
    const diagnosisTbTypeSection = document.getElementById('diagnosisTbTypeSection');
    const diagnosisOtherDetailSection = document.getElementById('diagnosisOtherDetailSection');

    function setRequired(section, required) {
        section.querySelectorAll("input, select").forEach(el => {
            if (!el.name.endsWith('_post')) el.required = required;
        });
    }

    function toggleIsPregnant() {
        const isFemale = document.querySelector('input[name="gender"]:checked')?.value === 'N·ªØ';
        isPregnantSection.classList.toggle("hidden", !isFemale);
        setRequired(isPregnantSection, isFemale);
        if (!isFemale) {
            document.querySelectorAll('input[name="isPregnant"]').forEach(radio => radio.checked = false);
        }
    }

    function toggleTbTreatments() {
        const hasTbHistory = historyTbCheckbox.checked;
        tuberculosisTreatmentsSection.classList.toggle("hidden", !hasTbHistory);
        setRequired(tuberculosisTreatmentsSection, hasTbHistory);
        if (!hasTbHistory) {
            document.getElementById('tuberculosisTreatments').value = '';
        }
    }

    function toggleContactSource() {
        const hasContact = document.querySelector('input[name="contactWithTuberculosis"]:checked')?.value === 'C√≥';
        contactSourceSection.classList.toggle("hidden", !hasContact);
        setRequired(contactSourceSection, hasContact);
        if (!hasContact) {
            document.getElementById('contactSourceName').value = '';
            document.querySelectorAll('input[name="contactSourceTbType"]').forEach(radio => radio.checked = false);
        }
    }

    function toggleXpertResult() {
        const hasXpertTest = document.querySelector('input[name="xpertTest"]:checked')?.value === 'C√≥';
        xpertResultSection.classList.toggle("hidden", !hasXpertTest);
        setRequired(xpertResultSection, hasXpertTest);
        if (!hasXpertTest) {
            document.getElementById('xpertResult').value = '';
        }
    }

    function toggleSpirometryResults() {
        const hasSpiroTest = document.querySelector('input[name="spirometryTest"]:checked')?.value === 'C√≥';
        spirometryResultsSection.classList.toggle("hidden", !hasSpiroTest);
        setRequired(spirometryResultsSection, hasSpiroTest);
        if (!hasSpiroTest) {
            spirometryResultsSection.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
        }
    }

    function toggleDiagnosisDetails() {
        const isAbnormal = document.querySelector('input[name="conclusion"]:checked')?.value === 'B·∫•t th∆∞·ªùng';
        diagnosisDetailsSection.classList.toggle("hidden", !isAbnormal);
        setRequired(diagnosisDetailsSection, isAbnormal);
        if (!isAbnormal) {
            diagnosisDetailsSection.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
            diagnosisDetailsSection.querySelectorAll('select, input[type="text"]').forEach(el => el.value = '');
            // Manually re-hide sub-sections
            diagnosisTbTypeSection.classList.add("hidden");
            diagnosisOtherDetailSection.classList.add("hidden");
        }
    }

    function toggleDiagnosisTbType() {
        const hasTbDiagnosis = document.querySelector('input[name="diagnosisTb"]:checked')?.value === 'C√≥';
        diagnosisTbTypeSection.classList.toggle("hidden", !hasTbDiagnosis);
        setRequired(diagnosisTbTypeSection, hasTbDiagnosis);
        if (!hasTbDiagnosis) {
            document.getElementById('diagnosisTbType').value = '';
        }
    }

    function toggleDiagnosisOtherDetail() {
        const hasOtherDiagnosis = document.querySelector('input[name="diagnosisOther"]:checked')?.value === 'C√≥';
        diagnosisOtherDetailSection.classList.toggle("hidden", !hasOtherDiagnosis);
        setRequired(diagnosisOtherDetailSection, hasOtherDiagnosis);
        if (!hasOtherDiagnosis) {
            document.getElementById('diagnosisOtherDetail').value = '';
        }
    }

    genderRadios.forEach(r => r.addEventListener("change", toggleIsPregnant));
    historyTbCheckbox.addEventListener("change", toggleTbTreatments);
    contactRadios.forEach(r => r.addEventListener("change", toggleContactSource));
    xpertTestRadios.forEach(r => r.addEventListener("change", toggleXpertResult));
    spirometryTestRadios.forEach(r => r.addEventListener("change", toggleSpirometryResults));
    conclusionRadios.forEach(r => r.addEventListener("change", toggleDiagnosisDetails));
    diagnosisTbRadios.forEach(r => r.addEventListener("change", toggleDiagnosisTbType));
    diagnosisOtherRadios.forEach(r => r.addEventListener("change", toggleDiagnosisOtherDetail));

    // --- APP INITIALIZATION & CONTROL ---
    async function initializeApp() {
        await updateAllViews();
        await resetForm();
    }
    initializeApp();

    // --- SIDEBAR CONTROLS ---
    document.getElementById('importDbBtn').addEventListener('click', () => fileLoader.click());
    fileLoader.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;
        if (!confirm('H√†nh ƒë·ªông n√†y s·∫Ω X√ìA S·∫†CH d·ªØ li·ªáu hi·ªán t·∫°i v√† thay th·∫ø b·∫±ng d·ªØ li·ªáu t·ª´ file. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?')) {
            fileLoader.value = ''; return;
        }
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (Array.isArray(data)) {
                    await db.transaction('rw', db.surveys, async () => {
                        await db.surveys.clear();
                        await db.surveys.bulkAdd(data);
                    });
                    alert(`ƒê√£ nh·∫≠p th√†nh c√¥ng ${data.length} phi·∫øu.`);
                    await updateAllViews();
                } else { alert('L·ªói: T·ªáp kh√¥ng h·ª£p l·ªá.'); }
            } catch (error) { alert('L·ªói ƒë·ªçc file: ' + error.message); }
        };
        reader.readAsText(file);
        fileLoader.value = '';
    });

    document.getElementById('clearDbBtn').addEventListener('click', async () => {
        if (confirm('!!! C·∫¢NH B√ÅO !!!\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën X√ìA TO√ÄN B·ªò C∆† S·ªû D·ªÆ LI·ªÜU kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
            await db.surveys.clear();
            alert('ƒê√£ x√≥a to√†n b·ªô d·ªØ li·ªáu.');
            await updateAllViews();
        }
    });

    // --- TAB SWITCHING LOGIC ---
    tabLinks.forEach(link => link.addEventListener('click', () => openTab(link.dataset.tab)));
    function openTab(tabId) {
        tabLinks.forEach(link => link.classList.remove('active'));
        tabContents.forEach(content => content.classList.remove('active'));
        document.querySelector(`.tab-link[data-tab="${tabId}"]`).classList.add('active');
        document.getElementById(tabId).classList.add('active');
    }

    // --- DATA HANDLING & RENDERING ---
    async function updateAllViews() {
        await filterAndRenderList();
        await generateReport();
    }
    
    async function generateUniquePatientId() {
        let newId, exists;
        do {
            newId = `${new Date().getFullYear()}-${Math.floor(1000 + Math.random() * 9000)}`;
            exists = await db.surveys.get(newId);
        } while (exists);
        return newId;
    }

    async function resetForm() {
        form.reset();
        document.getElementById('patientId').value = await generateUniquePatientId();
        document.getElementById('examDate').valueAsDate = new Date();
        document.getElementById('birthYear').max = new Date().getFullYear();
        editingPatientId = null;
        submitBtn.textContent = 'L∆∞u D·ªØ Li·ªáu';
        cancelEditBtn.classList.add('hidden');
        formTitle.textContent = 'PHI·∫æU KH√ÅM S√ÄNG L·ªåC C·ªòNG ƒê·ªíNG';
        document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(el => el.dispatchEvent(new Event('change')));
    }

    function getDiagnosisString(survey) {
        if (!survey) return '';
        const diagnoses = [];
        if (survey.diagnosisTb === 'C√≥') diagnoses.push(survey.diagnosisTbType || 'Lao');
        if (survey.diagnosisCopd === 'C√≥') diagnoses.push('BPTNMT');
        if (survey.diagnosisAsthma === 'C√≥') diagnoses.push('HPQ');
        if (survey.diagnosisOther === 'C√≥' && survey.diagnosisOtherDetail) diagnoses.push(survey.diagnosisOtherDetail);
        return diagnoses.join(', ') || (survey.conclusion === 'B√¨nh th∆∞·ªùng' ? 'B√¨nh th∆∞·ªùng' : 'B·∫•t th∆∞·ªùng');
    }

    async function filterAndRenderList() {
        let collection = db.surveys.toCollection();
        const filters = {};
        document.querySelectorAll('.filter-row input').forEach(input => {
            if (input.value) filters[input.dataset.filter] = input.value.toLowerCase();
        });

        let filteredSurveys = await collection.toArray();
        if (Object.keys(filters).length > 0) {
            filteredSurveys = filteredSurveys.filter(survey => {
                return Object.keys(filters).every(key => {
                    if (key === 'diagnosis') return getDiagnosisString(survey).toLowerCase().includes(filters[key]);
                    const surveyValue = survey[key] || '';
                    return surveyValue.toString().toLowerCase().includes(filters[key]);
                });
            });
        }

        const recentData = filteredSurveys.reverse().slice(0, 10);
        surveyListBody.innerHTML = recentData.map(survey => `
            <tr>
                <td>${survey.patientId || ''}</td>
                <td>${survey.fullName || ''}</td>
                <td>${survey.xrayResult || ''}</td>
                <td>${survey.xpertTest || ''}</td>
                <td>${getDiagnosisString(survey)}</td>
                <td class="action-buttons">
                    <button class="button button-warning" data-id="${survey.patientId}">S·ª≠a</button>
                    <button class="button button-danger" data-id="${survey.patientId}">X√≥a</button>
                </td>
            </tr>
        `).join('');
    }
    document.querySelectorAll('.filter-row input').forEach(input => input.addEventListener('keyup', filterAndRenderList));

    async function populateFormForEdit(patientId) {
        const data = await db.surveys.get(patientId);
        if (!data) {
            alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu cho b·ªánh nh√¢n n√†y.');
            return;
        }
        
        form.reset();
        editingPatientId = patientId;

        for (const key in data) {
            if (form.elements[key]) {
                const elements = form.elements[key];
                if (elements.constructor === RadioNodeList) {
                    const targetRadio = document.querySelector(`input[name="${key}"][value="${data[key]}"]`);
                    if (targetRadio) targetRadio.checked = true;
                } else if (elements.type === 'checkbox' || (elements.length > 0 && elements[0].type === 'checkbox')) {
                    if (Array.isArray(data[key])) {
                        data[key].forEach(value => {
                            const chk = document.querySelector(`input[name="${key}"][value="${value}"]`);
                            if (chk) chk.checked = true;
                        });
                    } else { elements.checked = data[key]; }
                } else {
                    elements.value = data[key] || '';
                }
            }
        }
        document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(el => el.dispatchEvent(new Event('change')));
        submitBtn.textContent = 'C·∫≠p nh·∫≠t D·ªØ li·ªáu';
        cancelEditBtn.classList.remove('hidden');
        formTitle.textContent = `CH·ªàNH S·ª¨A PHI·∫æU: ${data.fullName}`;
        window.scrollTo(0, 0);
    }
    
    // --- REPORTING LOGIC ---
    async function generateReport() {
        const allData = await db.surveys.toArray();
        if (allData.length === 0) {
            reportContainer.innerHTML = '<p style="text-align:center; color: var(--muted-text-color);">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫°o b√°o c√°o.</p>';
            return;
        }
        const total=allData.length; const totalNam=allData.filter(p=>p.gender==='Nam').length; const totalNu=allData.filter(p=>p.gender==='N·ªØ').length; const hasXquang=allData.filter(p=>p.xrayResult&&p.xrayResult!=='KH√îNG CH·ª§P').length; const hasXpert=allData.filter(p=>p.xpertTest==='C√≥').length; const hasSpiro=allData.filter(p=>p.spirometryTest==='C√≥').length; const diagnosisLao=allData.filter(p=>p.diagnosisTb==='C√≥').length; const diagnosisCopd=allData.filter(p=>p.diagnosisCopd==='C√≥').length; const diagnosisAsthma=allData.filter(p=>p.diagnosisAsthma==='C√≥').length; const diagnosisOther=allData.filter(p=>p.diagnosisOther==='C√≥').length;
        const createReportItem=(v,l)=>`<div class="report-item"><div class="value">${v}</div><div class="label">${l}</div></div>`;
        reportContainer.innerHTML = `<div class="report-grid">${createReportItem(total,'T·ªïng s·ªë ng∆∞·ªùi kh√°m')}${createReportItem(totalNam,'T·ªïng s·ªë Nam')}${createReportItem(totalNu,'T·ªïng s·ªë N·ªØ')}${createReportItem(hasXquang,'S·ªë ng∆∞·ªùi c√≥ ch·ª•p Xquang')}${createReportItem(hasXpert,'S·ªë ng∆∞·ªùi c√≥ XN Xpert')}${createReportItem(hasSpiro,'S·ªë ng∆∞·ªùi c√≥ ƒëo CNHH')}${createReportItem(diagnosisLao,'Ch·∫©n ƒëo√°n Lao')}${createReportItem(diagnosisCopd,'Ch·∫©n ƒëo√°n BPTNMT')}${createReportItem(diagnosisAsthma,'Ch·∫©n ƒëo√°n Hen ph·∫ø qu·∫£n')}${createReportItem(diagnosisOther,'Ch·∫©n ƒëo√°n Kh√°c')}</div>`;
    }

    // --- EVENT HANDLERS ---
    form.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const data = {};
        for (const key of new Set([...formData.keys()])) {
            const elements = form.elements[key];
            if (elements.length > 1 && elements[0].type === 'checkbox') {
                data[key] = formData.getAll(key);
            } else { data[key] = formData.get(key); }
        }
        
        try {
            await db.surveys.put(data);
            alert(editingPatientId ? `ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng cho b·ªánh nh√¢n ${data.fullName}.` : `ƒê√£ l∆∞u th√†nh c√¥ng b·ªánh nh√¢n ${data.fullName}.`);
            await updateAllViews();
            await resetForm();
            openTab('danhsach');
        } catch (error) {
            alert('L·ªói khi l∆∞u d·ªØ li·ªáu: ' + error);
        }
    });
    
    cancelEditBtn.addEventListener('click', () => resetForm());

    surveyListBody.addEventListener('click', async (event) => {
        const target = event.target;
        if (target.tagName !== 'BUTTON') return;
        const patientId = target.dataset.id;
        
        if (target.textContent === 'S·ª≠a') {
            await populateFormForEdit(patientId);
            openTab('nhaplieu');
        } else if (target.textContent === 'X√≥a') {
            const patientToDelete = await db.surveys.get(patientId);
            if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b·ªánh nh√¢n "${patientToDelete.fullName}"?`)) {
                await db.surveys.delete(patientId);
                await updateAllViews();
                if(editingPatientId === patientId) await resetForm();
            }
        }
    });

    // --- DATA EXPORT LOGIC ---
    function downloadFile(filename, content, mimeType) {
        const a = document.createElement('a'); const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob); a.download = filename; a.click(); URL.revokeObjectURL(a.href);
    }
    document.getElementById('exportDbBtn').addEventListener('click', async () => {
        const allData = await db.surveys.toArray();
        if (allData.length === 0) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ sao l∆∞u.');
        const filename = `backup_data_${new Date().toISOString().slice(0,10)}.json`;
        downloadFile(filename, JSON.stringify(allData, null, 2), 'application/json');
    });
    document.getElementById('exportXlsxBtn').addEventListener('click', async () => {
        const allData = await db.surveys.toArray();
        if (allData.length === 0) return alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
        const worksheet = XLSX.utils.json_to_sheet(allData); const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "DanhSach");
        XLSX.writeFile(workbook, `DanhSach_${new Date().toISOString().slice(0,10)}.xlsx`);
    });
});
</script>
</body>
</html>
